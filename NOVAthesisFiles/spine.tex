%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% spine.tex
%% NOVA thesis document template
%%
%% This work is licensed under the
%% The LaTeX project public license (LPPL), version 1.3c
%% To view a copy of this license, visit
%% https://www.latex-project.org/lppl/lppl-1-3c/
%%
%% Authors / Contributors:
%%      - João Lourenço <joao.lourenco@fct.unl.pt>
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\typeout{NT FILE spine.tex}%

% Draw the book spine
% usable range: 145 to 425 pages, maximum characters for the title 140 and 22 for the author name
% usable range: 75 to 145 pages, maximum characters for the title 70 and 22 for the author name

\makeatletter

\tcbuselibrary{fitting}

% \input{NOVAthesisFiles/fitbox2.sty}

%-----------------------------------------------------------------
% Set author name
\spine(author)=?{\thedocauthor(name,short)}

%-----------------------------------------------------------------
% Set thesis title
\datamatch{\match}{doctitle}({\@LANG@COVER,spine,cover},{\@LANG@COVER,spine})%
\spine(title):=?{\match}

%-----------------------------------------------------------------
% set date
\spine(date)=?{\thentdocdate(submission,year)}

%-----------------------------------------------------------------
% Defaults for spine

% minimum spine width
\spine(minwidth):=?{6mm}

% order of elements in the spine
\spine(order):=?{date,title,author,logo}

% default spine orientation
\spine(angle):=?{0}

% default background color and image
\spine(bg,color):=?{none}
\spine(image):=?{none}

% default text color and alignment
\spine(text,color):=?{black}
\spine(text,align):=?{c}

% no logo by default
\spine(logo):=?{none}

% unsure what this does
\spine(order,widthskip):={}
\spine(order,widthskip):={logo,\thespine(order,widthskip)}

% default space between boxes
\spine(boxsep):=?{0.5cm}

% default frame color
\spine(frame,color):=?{}

\spine(margin,top):=?{1mm}
\spine(margin,bottom):=?{1mm}
\spine(margin,left):=?{0.5cm}
\spine(margin,right):=?{0.5cm}

%-----------------------------------------------------------------
% Defaults for spine boxes
\spine(box,margin):=?{1.0mm}
\spine(box,bg,color):=?{none}
\spine(box,text,color):=?{black}

% Defaults for spine logo boxes
\spine(box,logo,len):=?{4.1cm}
\spine(box,logo,angle)=?{0}
\spine(box,logo,align):=?{c}
\spine(box,logo,raise):=?{0pt}
\spine(box,logo,scale):=?{1}
\spine(box,logo,margin,left):=?{2pt}
\spine(box,logo,margin,right):=?{2pt}
\spine(box,logo,margin,sep):=?{1mm}

% Defaults for spine author boxes
\spine(box,author,len):=?{4.0cm}
\spine(box,author,angle)=?{\thespine(angle)}
\spine(box,author,align)=?{\thespine(text,align)}
\spine(box,author,margin,left):=?{0pt}
\spine(box,author,margin,right):=?{0pt}

% Defaults for spine title boxes
\spine(box,title,len):=?{16.7cm}
\spine(box,title,angle)=?{\thespine(angle)}
\spine(box,title,align):=?{\thespine(text,align)}
\spine(box,title,margin,left):=?{0pt}
\spine(box,title,margin,right):=?{0pt}

% Defaults for spine date boxes
\spine(box,date,len):=?{2.0cm}
\spine(box,date,angle)=?{\thespine(angle)}
\spine(box,date,align):=?{\thespine(text,align)}
\spine(box,date,margin,left):=?{0pt}
\spine(box,date,margin,right):=?{0pt}



%-----------------------------------------------------------------
\newif\ifisdim
\newcommand{\@setifisdim}[1]{%
  \StrLeft{#1}{1}[\@dimleft]%
  \StrRight{#1}{1}[\@dimright]%
  \IfInteger{\@dimleft}{%
    \IfInteger{\@dimright}{%
      % Is a number
      \isdimfalse%
    }{%
      % May be a dimension
      \isdimtrue%
    }%
  }{%
    % Is a string
    \isdimfalse%
  }%
}
\newcommand{\IfIsDim}[3]{%
  \@setifisdim{#1}%
  \ifisdim#2\else#3\fi%
}

\ifoptioncontains{/novathesis/debug}{spine}{%
  \def\@spineboxdrawopacity{1}%
  \newcommand{\DEBUG}[1]{\typeout{#1}}%
}{%
  \def\@spineboxdrawopacity{0}%
  \newcommand{\DEBUG}[1]{}%
}%

\newdimen\@spinelen  % total spine length
\newcommand{\@checkspinelen}[1][\paperheight]{%
  \@tempdima=\thespine(margin,left)\relax%
  \@tempdimb=\thespine(margin,right)\relax%
  \DEBUG{SPINELEN MARGIN [left] = \the\@tempdima}%
  \DEBUG{SPINELEN MARGIN [right] = \the\@tempdimb}%
  \@tempdima=\dimexpr\@tempdima+\@tempdimb\relax%
  \DEBUG{SPINELEN ACCUMULATED = \the\@tempdima}%
  \StrCount{\thespine(order)}{,}[\@nBoxSep]%
  % \@tempdimb=\dimexpr\thespine(boxsep)*\@nBoxSep\relax%
  % \DEBUG{SPINELEN BOXSEP [all] = \the\@tempdimb}%
  % \@tempdima=\dimexpr\@tempdima+\@tempdimb\relax%
  % \DEBUG{SPINELEN ACCUMULATED = \the\@tempdima}%
  \@for\myi:=\expanded{\thespine(order)}\do{%
    \DEBUG{SPINELEN BOXLEN [\myi]}%
    \@tempdimb=\thespine(box,\myi,len)\relax%
    \DEBUG{SPINELEN BOXLEN [\myi] = \the\@tempdimb}%
    \@tempdima=\dimexpr\@tempdima+\@tempdimb\relax%
    \DEBUG{SPINELEN ACCUMULATED = \the\@tempdima}%
  }
  \DEBUG{SPINELEN MAX = \the#1}%
  \@spinelen=\@tempdima%
}


\newcommand{\@reverelist}[2]{%
%   % #1 = list to be reversed
  \def\@rvstmp{}%
  \@for\myi:={#1}\do{%
    \epreto\@rvstmp{,\myi}%
  }%
  \edef\@rvstmp{\expandafter\@gobble\@rvstmp}%
  \edef#2{\@rvstmp}%
}


% \providecommand*{\DivideLengths}[2]{%
%   \strip@pt\dimexpr\number\numexpr\number\dimexpr#1\relax*65536/\number\dimexpr#2\relax\relax sp\relax
% }


\newcommand{\@setlength}[2]{%
  \defifundef{#1}{\newlength}%
  \@tempdima=\dimexpr#2\relax%
  \setlength{#1}{\the\@tempdima}%
}

\newcommand{\ifnotnone}[2]{%
  \IfStrEq{#1}{none}{}{#2}%
}


\newcommand{\setspinewidth}{%
  \ifdim\option{/novathesis/spine/width}=0pt\relax% user DID NOT force the spine with - calculate it
    \@tempdima=\dimexpr0.05mm * (\thelastsheet+1)\relax%
% \DEBUG{NOVATHESIS SPINE width for \thelastsheet\space pages is \the\@SPWIDTH!}%
    \ifdim\@tempdima < \thespine(minwidth)\relax% Force book spine to be at least 6mm
% \DEBUG{NOVATHESIS SPINE width was \the\@SPWIDTH, forcing to 6mm!}%
      \@tempdima=\dimexpr\thespine(minwidth)\relax%
    \fi%
  \else% user DID force the spine with - use the given width
    \@tempdima=\dimexpr\option{/novathesis/spine/width}\relax%
% \DEBUG{NOVATHESIS SPINE width user forced by user to \the\@SPWIDTH!}%
  \fi%
% \DEBUG{NOVATHESIS SPINE \string\@SPWIDTH=\the\@SPWIDTH}%
  % remove spine top and bottom margins
  \@SPWIDTH=\dimexpr\@tempdima\relax%
% \DEBUG{NOVATHESIS SPINE FINAL \string\@SPWIDTH=\the\@SPWIDTH}%
}

\newdata{boxdim}
\spine(logo)={%
  \includegraphics[height=\theboxdim(height),
									 width=\theboxdim(width),
									 keepaspectratio,
									 angle=\@boxangle,
									 vshift=\@boxraise,
									]{\thespine(logo,\@DOCTYPE)}%
}
	
\newcommand*{\@processangle}{%
  \datamatchtf[0]{\@SPANGLE}{spine}(angle){}{}%
  \IfStrEqCase{\@SPANGLE}{
      {0}{  \def\@SPXSCALE{1}%
		        \def\@NODEANCHOR{west}%
		        \def\@GROUPANCHOR{west}%
            \def\@ROTATE{0}%
            \def\@TRANSFORMSHAPE{}%
            \ifoptionequal{/novathesis/spine/layout}{trim}{%
              \newstocksize{layoutsize={\the\paperheight,\@SPWIDTH},margin=0pt}
            }{\ifoptionequal{/novathesis/spine/layout}{notrim}{%
              \newstocksize{layoutsize={\the\paperheight,\the\paperwidth},margin=0pt}
            }{%
              \ClassError{novathesis}{Unknown page dimensions for “spine/layout=\option{/novathesis/spine/layout}”}
            }}%
         }
     {90}{  \def\@SPXSCALE{1}%
		        \def\@NODEANCHOR{west}%
		        \def\@GROUPANCHOR{south}%
            \def\@TRANSFORMSHAPE{transform shape}%
            \ifoptionequal{/novathesis/spine/layout}{trim}{%
              \newstocksize{layoutsize={\@SPWIDTH,\the\paperheight},margin=0pt}
            }{\ifoptionequal{/novathesis/spine/layout}{notrim}{%
              \newstocksize{layoutsize={\the\paperwidth,\the\paperheight},margin=0pt}
            }{%
              \ClassError{novathesis}{Unknown page dimensions for “spine/layout=\option{/novathesis/spine/layout}”}
            }}%
         }
    {180}{  \def\@SPXSCALE{-1}%
		        \def\@NODEANCHOR{east}%
		        \def\@GROUPANCHOR{east}%
            \def\@SPANGLE{0}%
            \def\@TRANSFORMSHAPE{}%
            \ifoptionequal{/novathesis/spine/layout}{trim}{%
              \newstocksize{layoutsize={\the\paperheight,\@SPWIDTH},margin=0pt}
            }{\ifoptionequal{/novathesis/spine/layout}{notrim}{%
              \newstocksize{layoutsize={\the\paperheight,\the\paperwidth},margin=0pt}
            }{%
              \ClassError{novathesis}{Unknown page dimensions for “spine/layout=\option{/novathesis/spine/layout}”}
            }}%
         }
    {270}{  \def\@SPXSCALE{1}%
		        \def\@NODEANCHOR{west}%
		        \def\@GROUPANCHOR{north}%
            \def\@SPANGLE{-90}%
            \def\@TRANSFORMSHAPE{transform shape}%
            \ifoptionequal{/novathesis/spine/layout}{trim}{%
              \newstocksize{layoutsize={\@SPWIDTH,\the\paperheight},margin=0pt}
            }{\ifoptionequal{/novathesis/spine/layout}{notrim}{%
              \newstocksize{layoutsize={\the\paperwidth,\the\paperheight},margin=0pt}
            }{%
              \ClassError{novathesis}{Unknown page dimensions for “spine/layout=\option{/novathesis/spine/layout}”}
            }}%
         }
  }[%
    \CalssError{novathesis}{Invalid spine angle: “\@SPANGLE”. Should be wither “0”, “90”, “180”, or “270”.}{}%
  ]%
}

\newcommand{\PercentToDim}[3]{%
	#1 = dimension or percentage
	#2 = base for percentage
	#3 = macro for result
	\typeout{PtD [#1] [#2] [\string#3]}
	\IfEndWith{#1}{\%}{%
		\StrGobbleRight{#1}{1}[\@PtD]%
		\edef#3{\the\dimexpr#2*\@PtD/100\relax}%
		\typeout{PtD PERC #3}
	}{\edef#3{#1}\typeout{PtD DIM #3}}%
}

\newcommand{\@ntprintspine}{%
  \NTRunHook{spine/pre}%
  \newlength\@SPWIDTH%
  \setspinewidth%
  \newlength\@SPHEIGHT%
  \@SPHEIGHT=\the\paperheight%
  % \@SPWIDTH=\the\paperwidth
	\@processangle%
  \newlength\@SPCURPOSX%
  \@SPCURPOSX=\dimexpr\thespine(margin,left)\relax%
  % Create a savebox
  \newsavebox\@spinebox
  % \begin{lrbox}{\@spinebox}
  \begin{tikzpicture}[remember picture, overlay,
						\@TRANSFORMSHAPE,
						rotate=\@SPANGLE,
						xscale=\@SPXSCALE,
										 ]
  % count the number of elements in the cover
  \newcount\@SPNELEM%
  % The accumulated size of all the elemnts
  \newdimen\@SPLEN
  % iterate the cover elements and draw them
  \@for\myi:=\expanded{\thespine(order)}\do{%
    \advance\@SPNELEM 1\relax%
    \@SPLEN=\dimexpr\@SPLEN+\thespine(box,\myi,len)\relax%
  }
  % Claculate the total unused (empty) space between elements
  \newdimen{\@SPUNUSEDTOTAL}%
  \@SPUNUSEDTOTAL=\dimexpr\@SPHEIGHT-\@SPLEN-\thespine(margin,left)
                                            -\thespine(margin,right)\relax%
  
  % Claculate the unused (empty) space to leave between every two elements
  \newdimen{\@SPUNUSEDSINGLE}%
  \@SPUNUSEDSINGLE=\dimexpr\@SPUNUSEDTOTAL/(\@SPNELEM-1)\relax
  % deal with debugging
  \ifoptioncontains{/novathesis/debug}{spine}{%
    \def\@boxrule{0.5pt}%
    \def\@boxcolframe{\@boxcoltext}%
    \def\@boxdebug{}%
  }{%
	\def\@boxcolframe{\@boxcoltext}%
    \def\@boxrule{0pt}%
    \def\@boxdebug{frame empty}%
  }%
  %
  % print bg image IF DEFINED
  \datamatchtf{\arg}{thesiscover}({\@DOCTYPE,spine,image},
                                  {\@DOCCLASS,spine,image},
                                  {spine,image}){%
    \ifnotnone{\arg}{%
      \node[inner sep=0,xscale=\@SPXSCALE] at (current page.center)
        {\includegraphics[width=\@SPHEIGHT,height=\@SPWIDTH,angle=-0]{\arg}};
    }}{%
      \datamatchtf{\arg}{spine}({\@DOCTYPE,image},%
                                {\@DOCCLASS,image},%
                                {image},%
    ){%
      \ifnotnone{\arg}{%
	      \node[inner sep=0,xscale=\@SPXSCALE] at (current page.center)
	        {\includegraphics[width=\@SPHEIGHT,height=\@SPWIDTH,angle=-0]{\arg}};
    }}{%
      \ClassError{novathesis}{Undefined spine “image”}{}%
    }%
  }%
  %
  % iterate the cover elements and draw them
  \@for\myi:=\expanded{\thespine(order)}\do{%
    \def\@boxcolback{tcbcolback}%
    \def\@BOXBGOPACITY{0}% Defaults to transparent box background
    \datamatchtf{\@boxcolbacki}{spine}({box,\myi,bg,color},{box,bg,color})
                  {\ifnotnone{\@boxcolbacki}{\def\@boxcolback{\@boxcolbacki}
                                            \def\@BOXBGOPACITY{1}}}{}%
    \def\@boxcoltext{.}%
		% Process RAISE option
		\datamatchtf[0pt]{\@boxraise}{spine}({box,logo,\@DOCTYPE,raise},%
															 					 {box,logo,raise},%
																				 {box,raise}%
																				){}{}%
		\PercentToDim{\@boxraise}{\the\@SPWIDTH}{\@boxraise}%
		% Process ANGLE option
    % \datamatchtf[0]{\@boxanglei}{spine}({box,\myi,angle})
    %               {\ifnotnone{\@boxanglei}{\def\@boxangle{\@boxanglei}}\YES}
    %               {\NO}%
    \gdef\@boxangle{\thespine(box,\myi,angle)}
    % \typeout{BOXANGLE[\myi]=\@boxangle / \thespine(box,\myi,angle)}\BOXANGLE
		% Process TEXT COLOR option
    \datamatchtf{\@boxcoltexti}{spine}({box,\myi,text,color},{box,text,color})
                  {\ifnotnone{\@boxcoltexti}{\def\@boxcoltext{\@boxcoltexti}}}{}%
		% Process LEFT MARGIN option
    \datamatchtf[0pt]{\@boxml}{spine}({box,\myi,\@DOCTYPE,margin,left},%
																 {box,\myi,margin,left},%
																 {box,margin,left},{box,margin}){}{}%
		\PercentToDim{\@boxml}{\the\@SPWIDTH}{\@boxml}%
		% Process RIGHT MARGIN option
    \datamatchtf[0pt]{\@boxmr}{spine}({box,\myi,\@DOCTYPE,margin,right},%
																 {box,\myi,margin,right},%
																 {box,margin,right},{box,margin}){}{}%
    \PercentToDim{\@boxmr}{\the\@SPWIDTH}{\@boxmr}%
		% Process TOP MARGIN option
    \datamatchtf[0pt]{\@boxmt}{spine}({box,\myi,\@DOCTYPE,margin,top},%
																 {box,\myi,margin,top},%
																 {box,margin,top},{box,margin}){}{}%
    \PercentToDim{\@boxmt}{\the\@SPWIDTH}{\@boxmt}%
		% Process BOTTOM MARGIN option
    \datamatchtf[0pt]{\@boxmb}{spine}({box,\myi,\@DOCTYPE,margin,bottom},%
																 {box,\myi,margin,bottom},%
																 {box,margin,bottom},{box,margin}){}{}%
    \PercentToDim{\@boxmb}{\the\@SPWIDTH}{\@boxmb}%
		% Do not fit logo
    \IfStrEq{\myi}{logo}{\def\@FIT{}}{\def\@FIT{fit}}%
    \IfStrEqCase{\@boxangle}{
         {0}{  \boxdim(height):={\the\dimexpr\@SPWIDTH-\@boxmt-\@boxmb\relax}%
    	         \boxdim(width):={\the\linewidth}%
               \def\@XSHFT{0pt}%
            }
       {180}{  \boxdim(height):={\the\dimexpr\@SPWIDTH-\@boxmt-\@boxmb\relax}%
               \boxdim(width):={\the\linewidth}%
               \def\@XSHFT{0pt}%
            }
        {90}{  \boxdim(width):={\the\dimexpr\@SPWIDTH-\@boxmt-\@boxmb\relax}%
               \boxdim(height):={\the\linewidth}%
               \def\@XSHFT{-5pt}%
            }
       {270}{  \boxdim(width):={\the\dimexpr\@SPWIDTH-\@boxmt-\@boxmb\relax}%
               \boxdim(height):={\the\linewidth}%
               \def\@XSHFT{\the\dimexpr-\@SPWIDTH/3\relax}%
            }
    }
    \node[inner sep=0pt, anchor=\@NODEANCHOR, rotate=\@boxangle, xshift=\@XSHFT,
          % draw,
          % minimum width=\expanded{\thespine(box,\myi,usedlen)},
          % minimum height=\@SPWIDTHUSED,
          ]
      at ($(current page.\@GROUPANCHOR)+(\@SPCURPOSX,0)$) {%
                \begin{tcolorbox}[
                        size=minimal, valign=center, halign=flush center,
                        width=\expanded{\thespine(box,\myi,len)}, height=\@SPWIDTH,
                        left=\@boxml, right=\@boxmr, top=\@boxmt, bottom=\@boxmb,
                        colback=\@boxcolback, coltext=\@boxcoltext,
                        boxrule=\@boxrule, colframe=\@boxcolframe,
                        opacityback=\@BOXBGOPACITY, enhanced jigsaw,
                        \@boxdebug, \@FIT, fit fontsize macros, 
                ]%
                    % \typeout{LW=\the\linewidth}%
                    % \typeout{BD[\myi,width]=\theboxdim(width)}%
                    % \typeout{BD[\myi,height]=\theboxdim(height)}%
                    %                     \KJLHJKLHKHKHJKJLHJK
                    \renewcommand{\baselinestretch}{0.9}%
								    \typeout{SPNODE[\myi]=\thespine(\myi)}%
                    \Huge\thespine(\myi)%
                \end{tcolorbox}%
      };
    \@SPCURPOSX=\dimexpr\@SPCURPOSX
                  +(\thespine(box,\myi,len)+\@SPUNUSEDSINGLE)\relax%
  }
  \end{tikzpicture}
  % \end{lrbox}
  \NTRunHook{spine/post}%
}

